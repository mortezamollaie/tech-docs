# Limiting Connections and Requests in Nginx

Nginx provides several modules and directives to control the rate of connections and requests, helping protect your server from abuse and ensuring fair resource usage.

---

## ngx_http_limit_conn_module

This module limits the number of simultaneous connections for a given key (such as an IP address).

- **limit_conn_zone:** Defines the shared memory zone for tracking connections.
    ```nginx
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    ```
- **limit_conn:** Sets the maximum number of connections for the defined zone.
    ```nginx
    limit_conn addr 10;
    ```
- **limit_conn_status:** Sets the status code returned when the connection limit is exceeded (default: 503).
    ```nginx
    limit_conn_status 429;
    ```

---

## ngx_http_limit_req_module

This module limits the request processing rate for a given key.

- **limit_req_zone:** Defines the shared memory zone for tracking request rates.
    ```nginx
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=1r/s;
    ```
- **limit_req:** Applies the rate limit to a context (e.g., server or location).
    ```nginx
    limit_req zone=req_limit burst=5 nodelay;
    ```
    - **burst:** Allows a temporary excess of requests.
    - **nodelay:** Processes burst requests immediately, without delay.
- **limit_req_status:** Sets the status code returned when the request limit is exceeded (default: 503).
    ```nginx
    limit_req_status 429;
    ```

---

## Bandwidth Limiting

- **limit_rate:** Limits the response rate to a client (in bytes per second).
    ```nginx
    limit_rate 100k;
    ```
- **limit_rate_after:** Starts limiting the rate only after a certain amount of data has been sent.
    ```nginx
    limit_rate_after 500k;
    ```

---

## Measurement Units

- **k** or **K** = kilobytes (1024 bytes)
- **m** or **M** = megabytes (1024 kilobytes)
- **r/s** = requests per second

---

## Leaky Bucket Algorithm

Nginx uses the **leaky bucket** algorithm for request limiting. This algorithm allows bursts of requests but ensures the average rate does not exceed the configured limit.

---

## Example Configuration

```nginx
http {
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=1r/s;

    server {
        listen 80;

        location /download/ {
            limit_conn addr 2;
            limit_conn_status 429;

            limit_req zone=req_limit burst=10 nodelay;
            limit_req_status 429;

            limit_rate 200k;
            limit_rate_after 1m;
        }
    }
}
```
- Limits each IP to 2 simultaneous connections.
- Limits each IP to 1 request per second, with bursts up to 10.
- Returns HTTP 429 if limits are exceeded.
- Limits download speed to 200 KB/s after the first 1