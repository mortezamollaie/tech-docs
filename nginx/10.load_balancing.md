# The HTTP Upstream Module in Nginx

The **HTTP upstream module** in Nginx enables you to define groups of backend servers and implement advanced load balancing strategies. This is essential for distributing client requests efficiently and ensuring high availability.

---

## `upstream` and `server` Directives

The `upstream` block defines a group of backend servers. Each `server` directive inside the block specifies a backend server and can include parameters for load balancing and health checks.

**Example:**
```nginx
upstream backend {
    server 192.168.1.10;
    server 192.168.1.11;
}
server {
    location / {
        proxy_pass http://backend;
    }
}
```
Requests to `/` will be distributed between the servers in the `backend` group.

---

## Load Balancing Methods

Nginx supports several load balancing methods in the upstream module:

- **Round Robin (default):** Requests are distributed evenly across all servers.
- **least_conn:** Sends requests to the server with the fewest active connections.
    ```nginx
    upstream backend {
        least_conn;
        server 192.168.1.10;
        server 192.168.1.11;
    }
    ```
- **ip_hash:** Requests from the same client IP are always sent to the same server.
    ```nginx
    upstream backend {
        ip_hash;
        server 192.168.1.10;
        server 192.168.1.11;
    }
    ```
- **hash:** Allows custom hashing based on a variable (e.g., URI).
    ```nginx
    upstream backend {
        hash $request_uri consistent;
        server 192.168.1.10;
        server 192.168.1.11;
    }
    ```
- **least_time:** Sends requests to the server with the lowest average response time (requires commercial NGINX Plus).
    ```nginx
    upstream backend {
        least_time header;
        server 192.168.1.10;
        server 192.168.1.11;
    }
    ```
- **random:** Selects a server at random, optionally with weights.
    ```nginx
    upstream backend {
        random two least_conn;
        server 192.168.1.10 weight=3;
        server 192.168.1.11;
    }
    ```

---

## Weights and Backup Servers

- **weight:** Assigns more requests to servers with higher weights.
    ```nginx
    upstream backend {
        server 192.168.1.10 weight=3;
        server 192.168.1.11 weight=1;
    }
    ```
- **backup:** Marks a server as a backup, used only if all primary servers are unavailable.
    ```nginx
    upstream backend {
        server 192.168.1.10;
        server 192.168.1.11 backup;
    }
    ```

---

## Health Checks

Nginx can monitor the health of backend servers using the following parameters:

- **max_fails:** Number of failed attempts before marking a server as unavailable.
- **fail_timeout:** Time period for counting failures and how long to consider the server unavailable.

**Example:**
```nginx
upstream backend {
    server 192.168.1.10 max_fails=3 fail_timeout=30s;
    server 192.168.1.11;
}
```
If `192.168.1.10` fails 3 times within 30 seconds, it will be marked as unavailable for 30 seconds.

---

## Implementing a Load Balancer

To use the upstream module as a load balancer, define your backend servers in an `upstream` block and reference it in your `proxy_pass` directive:

```nginx
upstream backend {
    least_conn;
    server 192.168.1.10 max_fails=3 fail_timeout=30s;
    server 192.168.1.11 backup;
}
server {
    listen 80;
    location / {
        proxy_pass http://backend;
    }
}
```
This configuration balances requests using the least connections method, includes health checks, and uses a backup server for high availability.